var app=angular.module("plan",["ngRoute","templates"]);app.config(function(e){e.when("/",{templateUrl:"states/main.html",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}),app.config(function(e){e.interceptors.push("authInterceptor")}),angular.module("templates",[]).run(["$templateCache",function(e){e.put("states/main.html",'<div ng-controller="UserCtrl"><form ng-show="!isAuthenticated" ng-submit="submit()"><input ng-model="user.username" type="text" name="user" placeholder="Username"><input ng-model="user.password" type="password" name="pass" placeholder="Password"><input type="submit" value="Login"></form><button ng-click="openPopUp()">Login with Facebook</button><div>{{error}}</div><span ng-show="isAuthenticated">{{welcome}}</span><div ng-show="isAuthenticated"><a ng-click="callRestricted()" href="">Shh, this is private!</a><br><div>{{message}}</div><a ng-click="logout()" href="">Logout</a></div></div>')}]),app.controller("UserCtrl",["$scope","$http","$window","$timeout","Utils",function(e,t,o,s,n){if(e.user={email:"john@doe.com",password:"foobar",id:234658,socId:!1,socToken:!1},o.sessionStorage.token){var a=o.sessionStorage.token;e.isAuthenticated=!0;var r=a.split(".")[1],i=JSON.parse(n.url_base64_decode(r));e.welcome="Welcome "+i.first_name+" "+i.last_name}else e.isAuthenticated=!1,e.welcome="",e.message="";e.submit=function(){t.post("/api/auth/local",e.user).success(function(t){o.sessionStorage.token=t.token,e.isAuthenticated=!0;var s=t.token.split(".")[1],a=JSON.parse(n.url_base64_decode(s));e.welcome="Welcome "+a.first_name+" "+a.last_name}).error(function(){delete o.sessionStorage.token,e.isAuthenticated=!1,e.error="Error: Invalid user or password",e.welcome=""})},e.logout=function(){e.welcome="",e.message="",e.isAuthenticated=!1,delete o.sessionStorage.token},e.callRestricted=function(){t({url:"/api/user/restricted",method:"GET"}).success(function(t){e.message=e.message+" "+t.name+" "+t.email}).error(function(e){alert(e)})},e.facebookAuth=function(){var n=o.open("http://localhost:8080/auth/facebook","","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=580, height=600"),a=!1;o.addEventListener("message",function(o){console.log(o.data),o.data.success&&(a=!0,e.user={email:!1,password:!1,id:!1,socId:o.data.userid,socToken:o.data.accessToken},t.post("/api/auth/facebook",e.user).success(function(){}).error(function(){}))});var r=function(){s(function(){n.closed&&!a||n.closed||r()},500)};r()}}]),app.factory("authInterceptor",function(e,t,o){return{request:function(e){return e.headers=e.headers||{},o.sessionStorage.token&&(e.headers.Authorization="Bearer "+o.sessionStorage.token),e},response:function(e){return 401===e.status,e||t.when(e)}}}),app.factory("Utils",function(){return{url_base64_decode:function(e){var t=e.replace("-","+").replace("_","/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}return window.atob(t)}}});